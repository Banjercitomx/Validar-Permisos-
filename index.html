<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Valida tu permiso</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: white;
    }
    h1 {
      text-align: center;
      font-size: 28px;
      margin-top: 40px;
      font-weight: 700;
    }
    p.subtitle {
      text-align: center;
      color: #555;
      margin-top: -10px;
      margin-bottom: 25px;
      font-size: 16px;
    }
    .container {
      width: 90%;
      max-width: 500px;
      margin: auto;
      background: #f2f2f2;
      padding: 25px;
      border-radius: 15px;
    }
    label {
      font-weight: bold;
      font-size: 14px;
      color: #333;
    }
    input {
      width: 100%;
      padding: 15px;
      margin: 8px 0 18px 0;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 16px;
      box-sizing: border-box;
    }
    #captchaCanvas {
      display: block;
      width: 160px;
      height: 50px;
      margin-bottom: 10px;
      background: #fff;
      border-radius: 4px;
    }
    .buttons {
      display: flex;
    }
    button {
      width: 50%;
      padding: 15px;
      border: none;
      font-size: 16px;
      color: white;
      cursor: pointer;
    }
    #clearBtn {
      background: #2ca34f;
      border-radius: 10px 0 0 10px;
    }
    #validateBtn {
      background: #2ca34f;
      border-radius: 0 10px 10px 0;
    }
  </style>
</head>

<body>

  <h1>Valida tu permiso</h1>

  <p class="subtitle">
    Por favor, captura los datos que se encuentran en tu Permiso de Importación
  </p>

  <div class="container">

    <label>FOLIO DE PERMISO:</label>
    <input type="text" placeholder="Folio permiso" id="folio">

    <label>ÚLTIMOS 5 CARACTERES DEL NÚMERO DE SERIE<br>DEL VEHÍCULO O HIN DEL VEHÍCULO:</label>
    <input type="text" placeholder="VIN/HIN" maxlength="5" id="vin">

    <label>ÚLTIMOS 5 CARACTERES DEL NÚMERO DE<br>DOCUMENTO O DEL RFC:</label>
    <input type="text" placeholder="Número de documento o RFC" maxlength="5" id="rfc">

    <!-- CAPTCHA -->
    <canvas id="captchaCanvas"></canvas>
    <input type="text" placeholder="Captcha" id="captchaInput">

    <div class="buttons">
      <button id="clearBtn" type="button">LIMPIAR</button>
      <button id="validateBtn" type="button">VALIDAR</button>
    </div>

  </div>

  <script>
    // ================================
    // BASE DE DATOS VEHÍCULOS
    // ================================
    const vehicles = [
      {
        folio: "50984679",
        marca: "TOYOTA",
        vinFull: "3TMLB5JN1RM011856",
        modelo: "2024",
        rfcLast5: "50278"
      },
      {
        folio: "50387787",
        marca: "CHEVROLET",
        vinFull: "1GCPWBEH6MZ117056",
        modelo: "2021",
        rfcLast5: "05943"
      },
      {
        folio: "50497849",
        marca: "HONDA",
        vinFull: "5J6RW2H59HL056248",
        modelo: "2017",
        rfcLast5: "50278"
      },
      {
        folio: "50697845",
        marca: "CHEVROLET",
        vinFull: "3GCUYEED6MG476841",
        modelo: "2021",
        rfcLast5: "05943"
      }
    ];

    let generatedCaptcha = "";

    // ================================
    // CAPTCHA
    // ================================
    function generarCaptcha() {
      const canvas = document.getElementById("captchaCanvas");
      const ctx = canvas.getContext("2d");

      canvas.width = 160;
      canvas.height = 50;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const chars = "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789";
      generatedCaptcha = "";

      for (let i = 0; i < 6; i++) {
        generatedCaptcha += chars.charAt(Math.floor(Math.random() * chars.length));
      }

      ctx.font = "32px Georgia";
      ctx.fillStyle = "#000";

      // Draw characters with random angle
      for (let i = 0; i < generatedCaptcha.length; i++) {
        const angle = (Math.random() * 0.6) - 0.3;
        ctx.save();
        ctx.translate(20 + i * 22, 32);
        ctx.rotate(angle);
        ctx.fillText(generatedCaptcha[i], 0, 0);
        ctx.restore();
      }

      // Noise lines
      ctx.strokeStyle = "#000";
      for (let i = 0; i < 8; i++) {
        ctx.beginPath();
        ctx.moveTo(Math.random() * 160, Math.random() * 50);
        ctx.lineTo(Math.random() * 160, Math.random() * 50);
        ctx.stroke();
      }
    }

    function limpiar() {
      document.getElementById("folio").value = "";
      document.getElementById("vin").value = "";
      document.getElementById("rfc").value = "";
      document.getElementById("captchaInput").value = "";
      generarCaptcha();
    }

    // ================================
    // VALIDACIÓN
    // ================================
    function validar() {
      const folio = document.getElementById("folio").value.trim();
      const vin = document.getElementById("vin").value.trim().toUpperCase();
      const rfc = document.getElementById("rfc").value.trim();
      const captchaIngresado = document.getElementById("captchaInput").value.trim();

      if (!folio || !vin || !rfc || !captchaIngresado) {
        alert("Por favor llena todos los campos.");
        return;
      }

      if (captchaIngresado.toLowerCase() !== generatedCaptcha.toLowerCase()) {
        alert("Captcha incorrecto. Intenta de nuevo.");
        generarCaptcha();
        document.getElementById("captchaInput").value = "";
        return;
      }

      // Buscar vehículo por folio
      const vehicle = vehicles.find(v => v.folio === folio);

      if (!vehicle) {
        alert("El folio no existe.");
        return;
      }

      // Validar últimos 5 del VIN
      const vinLast5 = vehicle.vinFull.slice(-5).toUpperCase();
      if (vin !== vinLast5) {
        alert("Los últimos 5 caracteres del VIN/HIN no coinciden.");
        return;
      }

      // Validar últimos 5 del RFC / documento
      if (rfc !== vehicle.rfcLast5) {
        alert("Los últimos 5 caracteres del documento/RFC no coinciden.");
        return;
      }

      // Redirigir con parámetros a verificar.html
      const url = new URL("verificar.html", window.location.href);
      url.searchParams.set("folio", vehicle.folio);
      url.searchParams.set("marca", vehicle.marca);
      url.searchParams.set("modelo", vehicle.modelo);
      url.searchParams.set("vin", vehicle.vinFull);

      window.location.href = url.toString();
    }

    document.getElementById("clearBtn").addEventListener("click", limpiar);
    document.getElementById("validateBtn").addEventListener("click", validar);

    window.onload = generarCaptcha;
  </script>

</body>
</html>
