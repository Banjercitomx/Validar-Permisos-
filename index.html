<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Valida tu permiso</title>

<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: white;
    }

    h1 {
        text-align: center;
        font-size: 28px;
        margin-top: 40px;
        font-weight: 700;
    }

    p.subtitle {
        text-align: center;
        color: #555;
        margin-top: -10px;
        margin-bottom: 25px;
        font-size: 16px;
    }

    .container {
        width: 90%;
        max-width: 500px;
        margin: auto;
        background: #f2f2f2;
        padding: 25px;
        border-radius: 15px;
    }

    label {
        display: block;
        font-weight: 700;
        font-size: 14px;
        color: #333;
        margin-bottom: 6px;
    }

    .input-group {
        margin-bottom: 18px;
    }

    input[type="text"] {
        width: 100%;
        padding: 14px;
        border-radius: 10px;
        border: 1px solid #ccc;
        font-size: 18px;
        box-sizing: border-box;
        text-align: left;         /* left-justified text */
    }

    input[type="text"]::placeholder {
        color: #9b9b9b;          /* gray hint text */
        opacity: 1;
        text-align: left;
    }

    #captchaCanvas {
        display: block;
        width: 160px;
        height: 50px;
        margin-bottom: 10px;
        background: #fff;
        border-radius: 4px;
    }

    .buttons {
        display: flex;
        margin-top: 8px;
    }

    button {
        width: 50%;
        padding: 15px;
        border: none;
        font-size: 16px;
        color: white;
        cursor: pointer;
    }

    #clearBtn {
        background: #2ca34f;
        border-radius: 10px 0 0 10px;
    }

    #validateBtn {
        background: #2ca34f;
        border-radius: 0 10px 10px 0;
    }
</style>
</head>

<body>

<h1>Valida tu permiso</h1>

<p class="subtitle">
    Por favor, captura los datos que se encuentran en tu Permiso de Importación
</p>

<div class="container">

    <div class="input-group">
        <label for="folio">FOLIO DE PERMISO:</label>
        <input
            type="text"
            id="folio"
            placeholder="Folio permiso"
            maxlength="8"
            autocomplete="off"
        >
    </div>

    <div class="input-group">
        <label for="vin">
            ÚLTIMOS 5 CARACTERES DEL NÚMERO DE SERIE DEL VEHÍCULO O HIN DEL VEHÍCULO:
        </label>
        <input
            type="text"
            id="vin"
            placeholder="VIN/HIN"
            maxlength="5"
            autocomplete="off"
        >
    </div>

    <div class="input-group">
        <label for="rfc">
            ÚLTIMOS 5 CARACTERES DEL NÚMERO DE DOCUMENTO O DEL RFC:
        </label>
        <input
            type="text"
            id="rfc"
            placeholder="Número de documento o RFC"
            maxlength="5"
            autocomplete="off"
        >
    </div>

    <!-- CAPTCHA -->
    <canvas id="captchaCanvas"></canvas>
    <input
        type="text"
        id="captchaInput"
        placeholder="Captcha"
        autocomplete="off"
    >

    <div class="buttons">
        <button id="clearBtn" type="button">LIMPIAR</button>
        <button id="validateBtn" type="button">VALIDAR</button>
    </div>

</div>

<script>
// BASE DE DATOS DE VEHÍCULOS
const vehicles = [
  { folio: "50984679", marca: "TOYOTA",    vinFull: "3TMLB5JN1RM011856", modelo: "2024", rfcLast5: "50278" },
  { folio: "50387787", marca: "CHEVROLET", vinFull: "1GCPWBEH6MZ117056", modelo: "2021", rfcLast5: "05943" },
  { folio: "50497849", marca: "HONDA",     vinFull: "5J6RW2H59HL056248", modelo: "2017", rfcLast5: "50278" },
  { folio: "50697845", marca: "CHEVROLET", vinFull: "3GCUYEED6MG476841", modelo: "2021", rfcLast5: "05943" }
];

// CAPTCHA
let generatedCaptcha = "";

function generarCaptcha() {
    const canvas = document.getElementById("captchaCanvas");
    const ctx = canvas.getContext("2d");

    canvas.width  = 160;
    canvas.height = 50;
    ctx.clearRect(0, 0, 160, 50);

    const chars = "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789";
    generatedCaptcha = "";

    for (let i = 0; i < 6; i++) {
        generatedCaptcha += chars.charAt(Math.floor(Math.random() * chars.length));
    }

    ctx.font = "32px Georgia";
    ctx.fillStyle = "#000";

    for (let i = 0; i < generatedCaptcha.length; i++) {
        const angle = (Math.random() * 0.6) - 0.3;
        ctx.save();
        ctx.translate(20 + i * 22, 32);
        ctx.rotate(angle);
        ctx.fillText(generatedCaptcha[i], 0, 0);
        ctx.restore();
    }

    ctx.strokeStyle = "#000";
    for (let i = 0; i < 8; i++) {
        ctx.beginPath();
        ctx.moveTo(Math.random() * 160, Math.random() * 50);
        ctx.lineTo(Math.random() * 160, Math.random() * 50);
        ctx.stroke();
    }
}

function limpiar() {
    document.getElementById("folio").value = "";
    document.getElementById("vin").value   = "";
    document.getElementById("rfc").value   = "";
    document.getElementById("captchaInput").value = "";
    generarCaptcha();
}

function validar() {
    const folio = document.getElementById("folio").value.replace(/\s+/g, '').trim();
    const vin   = document.getElementById("vin").value.replace(/\s+/g, '').toUpperCase();
    const rfc   = document.getElementById("rfc").value.replace(/\s+/g, '');
    const cap   = document.getElementById("captchaInput").value.trim();

    if (!folio || !vin || !rfc || !cap) {
        alert("Por favor llena todos los campos.");
        return;
    }

    if (cap.toLowerCase() !== generatedCaptcha.toLowerCase()) {
        alert("Captcha incorrecto. Intenta de nuevo.");
        generarCaptcha();
        return;
    }

    const v = vehicles.find(a => a.folio === folio);
    if (!v) {
        alert("El folio no existe.");
        return;
    }

    const vinLast5 = v.vinFull.slice(-5).toUpperCase();
    const vinInput = vin.replace(/O/g, "0").replace(/I/g, "1");

    if (vinInput !== vinLast5) {
        alert("Los últimos 5 caracteres del VIN/HIN no coinciden.");
        return;
    }

    if (rfc !== v.rfcLast5) {
        alert("Los últimos 5 caracteres del documento/RFC no coinciden.");
        return;
    }

    const url = new URL("verificar.html", window.location.href);
    url.searchParams.set("folio",  v.folio);
    url.searchParams.set("marca",  v.marca);
    url.searchParams.set("modelo", v.modelo);
    url.searchParams.set("vin",    v.vinFull);

    window.location.href = url.toString();
}

document.getElementById("clearBtn").addEventListener("click", limpiar);
document.getElementById("validateBtn").addEventListener("click", validar);

window.onload = generarCaptcha;
</script>

</body>
</html>
